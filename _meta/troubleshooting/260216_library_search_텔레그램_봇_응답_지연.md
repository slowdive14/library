---
type: troubleshooting
status: done
description: "텔레그램 봇이 응답하지 않거나 매우 느리게 반응하는 문제 해결 (타임아웃 및 피드백 개선)"
created: 2026-02-16
modified: 2026-02-16
phase: bug-fix
---

# 문제
> 텔레그램 봇에게 메시지를 보내도 응답이 없거나, 한참 뒤에 반응함. 사용자는 봇이 죽었는지 살았는지 알 수 없는 상태.

---

# 시도
- 텔레그램 `getUpdates` API 확인: 처리되지 않은 업데이트(Pending Updates)가 쌓여 있음을 확인.
- 로컬에서 봇 실행: 로컬에서 실행하자마자 쌓여있던 메시지들이 처리됨. 즉, 서버(Render)의 봇 프로세스가 '먹통(Hang)' 상태였음.
- 코드 분석: `requests` 라이브러리를 사용한 네트워크 요청에 `timeout` 설정이 없는 것을 확인.

---

# 원인
- **동기식 블로킹**: `bot.py`는 비동기(asyncio) 기반인 `python-telegram-bot`을 사용하지만, 내부에서 도서관 API와 구글 시트 요청 시 동기 방식인 `requests`를 사용함.
- **무한 대기**: 외부 API가 응답하지 않거나 매우 느릴 때 `timeout`이 없으면 봇 전체가 그 요청이 끝날 때까지 멈춰버림(Event Loop Blocking).
- **배포 오설정 (Render)**: Render의 무료 티어에서 봇이 시작될 때 포트(Port) 바인딩(Health Check)이 늦거나 실패하면 서버가 즉시 종료되어 봇이 응답하지 않음.
- **피드백 부재**: 검색 등 시간이 걸리는 작업 시 사용자에게 "처리 중"임을 알리지 않아 사용자는 응답이 없다고 느낌.

---

# 해결
- **타임아웃 추가**: 모든 `requests.get` 요청에 `timeout=10`을 설정하여 무한 대기를 방지함.
- **즉각 피드백 구현**: `/s`, `/a` 명령 수신 시 즉시 "🔍 검색 중..." 메시지를 보내고, 결과가 나오면 업데이트함.
- **Render 배포 최적화**: 헬스 체크용 HTTP 서버가 봇 초기화보다 먼저 시작되도록 순서를 조정하고 포트 바인딩 안정성을 높임.
- **예외 처리 및 파싱 강화**: 구글 시트 연결 및 API 오류 상황에 대한 로직을 보강함.

---

# 관련 파일
- `c:\Users\user\Downloads\library_search\bot.py`

---

# 재발 방지
- 앞으로 모든 네트워크 요청에는 반드시 `timeout`을 명시할 것.
- 비동기 환경에서는 가급적 `httpx`나 `aiohttp` 같은 비동기 라이브러리 사용을 권장하나, `requests` 유지 시에는 반드시 타임아웃과 함께 별도 스레드 검토 필요 (현재는 타임아웃으로 우선 조치).
- 사용자 경험을 위해 "작업 중"임을 알리는 응답을 최우선으로 보낼 것.

---

# 📝 쉬운 설명

### 문제
도서관 봇에게 말을 걸어도 대답이 없어서 확인해보니, 봇이 도서관 홈페이지에 정보를 물어보러 갔다가 대답을 안 해줘서 계속 기다리기만 하느라 멍을 때리고 있었습니다.

### 원인  
봇이 너무 인내심이 좋아서(타임아웃 없음), 상대방이 대답을 안 해주면 1시간이고 2시간이고 그 자리에서 기다리느라 다른 사람의 말을 아예 못 듣는 상태였습니다.

### 해결
이제 봇에게 "10초만 기다려보고 대답 없으면 그냥 돌아와"라고 시계를 채워주었으며, 주인이 말을 걸면 일단 "찾아보고 올게요!"라고 먼저 대답하게 만들었습니다. 또한, Render라는 집(서버)에서 봇이 쫓겨나지 않도록 헬스 체크 기능을 더 튼튼하게 고쳤습니다.

### 관련 파일
- `C:/Users/user/Downloads/library_search/bot.py`
